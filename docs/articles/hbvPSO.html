<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hbvPSO • hbvPSO</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">hbvPSO</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/hbvPSO.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/test.html">HTML-Class Demo</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jthurner/hbvPSO">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>hbvPSO</h1>
                        <h4 class="author">Joschka Thurner</h4>
            
            <h4 class="date">2018-01-05</h4>
          </div>

    
    
<div class="contents">
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>
white-space: pre; }

<section id="managing-optimization-run-configurations-with-hbv_pso_run" class="level2"><h2>Managing optimization-run configurations with hbv_pso_run</h2>
<p>When you are calling <code>hbv_pso</code>, chances are you will not do so from the commandline but at the end of an R script in which you first set up all the different options and your input time series. If you need to do multiple optimization runs, for example when comparing different objective functions or precipitation products, this setup quickly becomes unwieldy.</p>
<p>The <code>hbv_pso_run</code> function provides a simple framework for managing (and running) many different <code>hbv_pso</code> configurations with a minimal amount of boiler plate, while still allowing for flexibility where required. The core ideas are:</p>
<ul>
<li>specify the arguments for ‘hbv_pso’ in dedicated R scripts which contain no other logic</li>
<li>discover and load input data directly from certain files by default to further seperate code and configuration</li>
<li>use <code>source</code> to import base configurations and selectively overwrite parameters</li>
</ul>
<section id="unpacking-example-data" class="level3"><h3>Unpacking example data</h3>
<p>Download the <a href="">example data</a> and extract it to your local system. In the remainder of this document it will be assumed that you assigned the path to the extracted data folder to a variable with the name <code>hpi</code> (for hbv_pso_imperial). Also make sure you have the <code>hbvPSO</code> package loaded:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(hbvPSO)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">hpi &lt;-<span class="st"> "/path/to/example/directory"</span></a></code></pre></div>
</section><section id="the-basics" class="level3"><h3>The Basics</h3>
<p>The only required argument for <code>hbv_pso_run</code> is <code>configpath</code>. In the simplest case, this represents the path to a configuration file which, when sourced, provides the arguments for <code>hbv_pso</code> as variables. It will then execute <code>hbv_pso</code> with the provided arguments and return the results. As an example, run the following file for the example data from <code>TUWmodel</code> (this will take a couple of minutes):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># res &lt;- hbv_pso_run(file.path(hpi,"tuwmodel_example/run_default.R"))</span></a></code></pre></div>
<p>While the optimization is running, have a look at the file <code>tuwmodel_example/run_default.R</code>. The first line sources a seperate configuration file located in the parent directory:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">source</span>(<span class="st">"../global_config.R"</span>,<span class="dt">local=</span><span class="ot">TRUE</span>,<span class="dt">chdir =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>By using <code>source</code> to include other files you can define a set of “default” options which are used in the majority of runs in a single place, which minimizes repeating yourself and allows you to easily change an argument for all runs.</p>
<p><strong>WARNING:</strong> When sourcing other configuration files, you must always use <code>local=TRUE</code>! Internally, all parameters are sourced into a seperate environment, so with the default options to <code>source</code> they would end up in the global environment and not be utilized. The <code>chdir</code> argument is useful because it allows you to use relative paths inside the configuration files.</p>
<p>Open the file <code>global_config.R</code> to see what default arguments have been set:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">library</span>(hydroGOF)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co"># a model run is identified by "foldername-gof.name-suffix"</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co"># suffix is optional, but can be used to add additional information</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># according to specific settings e.g. imperial_chirps-lnNSE-singlezone</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">suffix =<span class="st"> "nozones"</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co"># gof.name &lt;- "NSE"</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># start of calibration</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co"># from &lt;- "1998-01-01"</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">from &lt;-<span class="st"> "2000-01-01"</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co"># end of calibration</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">to &lt;-<span class="st"> "2010-12-31"</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co"># end of warmup (as date, date string, or number of days)</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">warmup &lt;-<span class="st"> "2001-01-01"</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co"># warmup &lt;- "1999-12-31"</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co"># start of validation (optional, set to NULL to disable)</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">from_validation &lt;-<span class="st"> "2011-01-01"</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co"># end of validation (optional, set to NULL to disable)</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">to_validation &lt;-<span class="st"> "2015-12-31"</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co"># forces the model to run with a single zone even if elevation zones</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="co"># are defined in hbv-light</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25">area &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26">elev_zones &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-27" data-line-number="27"></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">FUN_gof &lt;-<span class="st"> </span>hydroGOF<span class="op">::</span>NSE</a>
<a class="sourceLine" id="cb4-29" data-line-number="29">gof.name &lt;-<span class="st"> "lnNSE"</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"></a>
<a class="sourceLine" id="cb4-31" data-line-number="31"></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="co"># to use tcalt, set telev and add the tcalt range to the parameters, e.g.:</span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33"><span class="co"># param["tcalt",] &lt;- c(0,1.2)</span></a>
<a class="sourceLine" id="cb4-34" data-line-number="34">telev =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="co"># to use tcalt, set pelev and add the pcalt range to the parameters, e.g.:</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36"><span class="co"># param["pcalt",] &lt;- c(0,0.4)</span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37">pelev =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38"></a>
<a class="sourceLine" id="cb4-39" data-line-number="39">plotting =<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb4-40" data-line-number="40"></a>
<a class="sourceLine" id="cb4-41" data-line-number="41">control =<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb4-42" data-line-number="42">    <span class="dt">digits=</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb4-43" data-line-number="43">  <span class="dt">normalise =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb4-44" data-line-number="44">  <span class="dt">npart =</span> <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb4-45" data-line-number="45">  <span class="dt">maxit =</span> <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb4-46" data-line-number="46">  <span class="dt">reltol =</span> <span class="fl">1E-30</span>,</a>
<a class="sourceLine" id="cb4-47" data-line-number="47">  <span class="dt">Xini.type =</span> <span class="st">"lhs"</span>,</a>
<a class="sourceLine" id="cb4-48" data-line-number="48">  <span class="dt">Vini.type =</span> <span class="st">"lhs2011"</span>,</a>
<a class="sourceLine" id="cb4-49" data-line-number="49">  <span class="dt">c1 =</span> <span class="fl">2.05</span>,</a>
<a class="sourceLine" id="cb4-50" data-line-number="50">  <span class="dt">c2 =</span> <span class="fl">2.05</span>,</a>
<a class="sourceLine" id="cb4-51" data-line-number="51">  <span class="dt">use.IW =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb4-52" data-line-number="52">  <span class="dt">use.CF =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb4-53" data-line-number="53">  <span class="dt">topology =</span> <span class="st">"l"</span>,</a>
<a class="sourceLine" id="cb4-54" data-line-number="54">  <span class="dt">K =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb4-55" data-line-number="55">  <span class="dt">boundary.wall =</span> <span class="st">"absorbing2011"</span>,</a>
<a class="sourceLine" id="cb4-56" data-line-number="56">  <span class="dt">verbose =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb4-57" data-line-number="57">  <span class="dt">par.nnodes=</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>(),</a>
<a class="sourceLine" id="cb4-58" data-line-number="58">  <span class="dt">parallel =</span> <span class="st">"parallel"</span></a>
<a class="sourceLine" id="cb4-59" data-line-number="59">  <span class="co"># parallel = "none"</span></a>
<a class="sourceLine" id="cb4-60" data-line-number="60">)</a>
<a class="sourceLine" id="cb4-61" data-line-number="61">hydroPSO_args =<span class="st"> </span><span class="kw">list</span>(<span class="dt">control=</span>control)</a>
<a class="sourceLine" id="cb4-62" data-line-number="62"></a>
<a class="sourceLine" id="cb4-63" data-line-number="63"></a>
<a class="sourceLine" id="cb4-64" data-line-number="64"><span class="co"># control = list(</span></a>
<a class="sourceLine" id="cb4-65" data-line-number="65"><span class="co">#   normalise = TRUE,</span></a>
<a class="sourceLine" id="cb4-66" data-line-number="66"><span class="co">#   do.plots=TRUE,</span></a>
<a class="sourceLine" id="cb4-67" data-line-number="67"><span class="co">#   verbose = TRUE,</span></a>
<a class="sourceLine" id="cb4-68" data-line-number="68"><span class="co">#   par.nnodes=detectCores(),</span></a>
<a class="sourceLine" id="cb4-69" data-line-number="69"><span class="co">#   # parallel = "parallel"</span></a>
<a class="sourceLine" id="cb4-70" data-line-number="70"><span class="co">#   parallel = "none"</span></a>
<a class="sourceLine" id="cb4-71" data-line-number="71"><span class="co"># )</span></a></code></pre></div>
<!-- <!-- ```{r engine='bash', comment=''} -->
<p>–&gt; <!-- cat /home/joschka/hbvpso/examples/tuwmodel_example/run_default.R --> <!-- <!-- cat file.path(hpi,"tuwmodel_example/run_default.R") --> –&gt; <!-- ``` --></p>
<!-- ```{r} -->
<!-- names(res) -->
<!-- names(res$results) -->
<!-- names(res$results[[1]]) -->
<!-- res$summary -->
<!-- ``` -->
</section><section id="setting-up-multiple-folders" class="level3"><h3>Setting up multiple folders</h3>
</section><section id="run-recursive" class="level3"><h3>Run recursive</h3>
</section></section>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#managing-optimization-run-configurations-with-hbv_pso_run">Managing optimization-run configurations with hbv_pso_run</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Joschka Thurner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
